local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- UI หลัก
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SkyWalkUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- ปุ่มเปิด/ปิดเมนู (ลากได้)
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 60, 0, 60)
toggleButton.Position = UDim2.new(0, 20, 0, 20)
toggleButton.Text = "≡"
toggleButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 30
toggleButton.Parent = screenGui

-- ระบบลากปุ่ม
local dragging = false
local dragStart, startPos

toggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 
    or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = toggleButton.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement 
    or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        toggleButton.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)

-- เมนูหลัก
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 0)
frame.Position = UDim2.new(0, 20, 0, 90)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local uiListLayout = Instance.new("UIListLayout")
uiListLayout.Parent = frame
uiListLayout.Padding = UDim.new(0, 10)
uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- ฟังก์ชันสร้างปุ่มย่อย
local function createButton(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -20, 0, 45)
    btn.BackgroundColor3 = Color3.fromRGB(200,50,50)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 20
    btn.Text = text .. ": OFF"
    btn.Parent = frame
    return btn
end

-- ปุ่มในเมนู
local blockButton  = createButton("Block")
local walkButton   = createButton("Walk Mode")
local espButton    = createButton("ESP")
local bypassButton = createButton("Bypass")

-- สถานะ
local menuOpen = false
local blockEnabled, walkEnabled, espEnabled, bypassEnabled = false, false, false, false
local lastBlockPos = nil
local espObjects = {}

-- เปิด/ปิดเมนู
toggleButton.MouseButton1Click:Connect(function()
    if dragging then return end -- กันเผลอกดตอนลาก
    menuOpen = not menuOpen
    local goal = {}
    goal.Size = menuOpen and UDim2.new(0, 220, 0, 220) or UDim2.new(0, 220, 0, 0)
    TweenService:Create(frame, TweenInfo.new(0.3), goal):Play()
end)

-- ฟังก์ชัน toggle
local function toggleFeature(flag, button, name)
    flag = not flag
    button.Text = name .. ": " .. (flag and "ON" or "OFF")
    button.BackgroundColor3 = flag and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50)
    return flag
end

-- ปุ่ม Block
blockButton.MouseButton1Click:Connect(function()
    blockEnabled = toggleFeature(blockEnabled, blockButton, "Block")
end)

-- ปุ่ม Walk Mode
walkButton.MouseButton1Click:Connect(function()
    walkEnabled = toggleFeature(walkEnabled, walkButton, "Walk Mode")
end)

-- ปุ่ม ESP
espButton.MouseButton1Click:Connect(function()
    espEnabled = toggleFeature(espEnabled, espButton, "ESP")

    -- ลบ ESP ถ้าปิด
    if not espEnabled then
        for _, obj in pairs(espObjects) do
            obj:Destroy()
        end
        espObjects = {}
    end
end)

-- ปุ่ม Bypass
bypassButton.MouseButton1Click:Connect(function()
    bypassEnabled = toggleFeature(bypassEnabled, bypassButton, "Bypass")
end)

-- ฟังก์ชันสร้างบล็อก
local function createBlock(pos)
    local part = Instance.new("Part")
    part.Size = Vector3.new(6,1,6)
    part.Position = pos
    part.Anchored = true
    part.Material = Enum.Material.Neon
    part.Color = Color3.fromRGB(0,255,0)
    part.CanCollide = true
    part.Parent = workspace

    game.Debris:AddItem(part, 5)
    return part.Position
end

-- ฟังก์ชันสร้าง ESP
local function createESP(player)
    if player == LocalPlayer then return end
    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillColor = Color3.fromRGB(255,0,0)
    highlight.OutlineColor = Color3.fromRGB(255,255,255)
    highlight.Parent = player.Character
    espObjects[player] = highlight
end

-- Loop หลัก
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local root = char.HumanoidRootPart

    -- Block Mode (กดกระโดด)
    if blockEnabled then
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            createBlock(root.Position - Vector3.new(0, 3, 0))
        end
    end

    -- Walk Mode (สร้างต่อเนื่อง)
    if walkEnabled then
        local pos = root.Position - Vector3.new(0, 3, 0)
        if not lastBlockPos or (lastBlockPos - pos).Magnitude > 6 then
            lastBlockPos = createBlock(pos)
        end
    end

    -- ESP
    if espEnabled then
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and not espObjects[plr] then
                createESP(plr)
            end
        end
    end

    -- Bypass กันวาร์ป
    if bypassEnabled then
        pcall(function()
            root.Anchored = false
        end)
    end
end)
